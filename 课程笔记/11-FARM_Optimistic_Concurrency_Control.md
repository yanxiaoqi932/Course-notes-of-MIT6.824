# FARM: Optimistic Concurrency Control

## 1. FARM概述

FARM高性能的原因：

- FARM对数据块进行了分片，读写一个数据片可以由多个分片服务器并行完成；

- FARM采用了RAM技术而非磁盘来存储数据，这提高了数据的读写处理速度，另外使用了非易失性RAM（NVRAM）技术来实现持久性存储；

- FARM采用了RDMA技术，可以通过网卡（NIC）接收数据后直接发出指令对服务器内存中的数据进行读写，也可以采用kernel bypass技术，应用层可以不通过内核直接访问网卡。

## 2. NVRAM技术

由于FARM的数据都保存在RAM中，一旦数据中心发生了停电，RAM的数据就会全部丢失。

为了避免这一点，FARM在机架上安装了可以支持服务器继续运行10分钟左右的电池，一旦发生停电，电池立即开始供电，并给机架上所有服务器发送它们可以运行的剩余时间，**服务器会立即停止所有操作，将RAM内所有数据都写入固态磁盘中**，整个过程在10分钟内可以完成。

但是这种NVRAM方案只适用于断电故障。为了能够进一步适应其它故障，每个分片服务器还有自己的副本服务器，这些副本服务器RAM的数据会与它保持一致，一旦服务器停止运行，这些副本服务器会立即补上。

## 3. 应用程序直接访问网卡

服务器之间需要通过网络来传递读写信息，但是有一般情况下一条网络消息从网卡接收它开始，需要通过CPU进行一系列的处理才能到达应用层，这个过程产生了不小的时间开销。

### 3.1 kernel bypass

kernel bypass也就是完全绕过内核（也许操作系统作出了一定的修改），应用程序可以直接从网卡接收字节信息并处理。

### 3.2 RDMA

RDMA（remote direct memory access）NIC是一种智能网卡，它可以让应用层直接读取网卡的字节信息，而CPU是完全不知道也不用参与这一切的，因此省去了中间的处理过程。

kernel bypass和RDMA一般是放在一起使用的。通过这一方法，机器1秒钟可以实现1000万次读写。

## 4. 乐观并行控制策略（OCC）

### 4.1 OCC概述

RDMA确实大大提高了信息处理的速度，但是在两阶段提交的方案下，数据处理需要等待获得锁，这造成了数据处理的较长延时，**为了让RDMA发挥较好的性能，FARM没有采用悲观控制策略，而是采用了乐观控制策略（OCC），这种方案不需要引入锁机制**。

**乐观策略在发起事务之前就乐观地预设不会出现读写冲突，因此先执行事务后再去做验证；而悲观策略预设会发生冲突，因此才使用锁机制来避免**。

OCC的基本执行过程如下：

1. 当一个事务的指令到来时，直接执行这个事务；

2. 执行完事务后，开始对事务进行验证（validation），验证它读写的数据是否与其它事务冲突；

3. 如果冲突，则事务会回退回原状态，然后随机等待一段时间后重新执行；

4. 如果不冲突，则可以提交。

另外，在FARM中，为了让读操作读取到正确的数据，因此它也像spanner一样，每个数据都是有版本的（可以理解为时间戳）。

**乐观策略相对于悲观策略的优势在于它可以直接执行事务，而不用等待锁，再加上RDMA等技术使得FARM的处理速度相当快；劣势在于一旦发生冲突，事务就得回退重新执行，这会增加很多I/O开销。**

### 4.2 FARM对OCC的执行过程

FARM执行OCC的基本过程如下所示：

![](E:\研究生\其它事务\分布式系统\课程笔记\images\2023-01-16-13-19-50-20230116131857.png)

1. 首先是执行阶段。客户端会向数据所在的各个服务器发起读写操作，注意写入时同时也会写入数据的版本；

2. 接下来每个客户端读写过的primary服务器会对客户端新写入的Log进行查询，如果发现log设计的数据对象已经被锁上，或者客户端应当读取的数据版本与实际版本不符，那么就会返回NO，表示该操作无法执行，否则返回YES，同时为log的数据对象加上锁（加锁的原因是防止并行的多个事务争夺数据），只要有一个服务器返回NO，那么事务就无法提交；

3. 执行验证过程；

4. 如果验证成功，那就将结果提交给backup服务器；

5. 将结果提交给primary服务器，然后更新内存中的数据和版本，并释放锁。

举例如下：

假设数据x=0，两个事务T1和T2都执行对x加一的操作，最终有以下几种结果：

1. 两个事务都得到执行，x=2：
   
   <img src="file:///E:/研究生/其它事务/分布式系统/课程笔记/images/2023-01-16-13-56-07-20230116135303.png" title="" alt="" width="447">

2. 有一个事务因为没有锁或者版本错误而被FARM终止，x=1：
   
   <img src="file:///E:/研究生/其它事务/分布式系统/课程笔记/images/2023-01-16-13-57-00-20230116135333.png" title="" alt="" width="449">
   
   <img src="file:///E:/研究生/其它事务/分布式系统/课程笔记/images/2023-01-16-13-57-19-20230116135406.png" title="" alt="" width="450">
